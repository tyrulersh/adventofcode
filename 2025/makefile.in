TEST_CASES = $(patsubst tst/%.input.txt,test-%,$(wildcard tst/*.input.txt))

all: test

$(PROGRAM): src/$(PROGRAM).hs
	ghc -dynamic -o $@ $<

test: $(TEST_CASES)

test-%: tst/%.input.txt tst/%.expected.txt $(PROGRAM)
	@temp_file=`mktemp`; \
	    cat $< | ./$(PROGRAM) > $$temp_file; \
	    (cmp --silent $$temp_file $(word 2,$^) && echo -e "\e[32mPASS\e[0m" $@) \
			    || (echo -e "\e[31mFAIL\e[0m" $@ && diff -u $$temp_file $(word 2,$^)) || true

clean:
	rm -f $(PROGRAM) src/$(PROGRAM).hi src/$(PROGRAM).o
